<!DOCTYPE html>
<html lang="en">
<head>
  <title>Alok Menghrajani's stuff | ajsone: Abusing JSON Esolang</title>
  <meta property="fb:admins" content="536181839"/>
  <meta name="author" content="Alok Menghrajani"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../bootstrap-responsive.min.css" rel="stylesheet">
  <link href="../bootstrap-2.3.1.min.css" rel="stylesheet"/>
  <link href="../alok.css" rel="stylesheet"/>
  <script type="text/javascript" src="../jquery-1.7.1.min.js"></script>
  <link href="../prettify/prettify.css" type="text/css" rel="stylesheet"/>
  <script type="text/javascript" src="../prettify/prettify.js"></script>
  <script type="text/javascript" src="ajsone.js"></script>
  <script type="text/javascript" src="ajsone_utils.js"></script>
</head>
<body onload="prettyPrint()">
  <div class="container-narrow">
    <div class="menu visible-desktop">
      <div class="profile">
        <p class="pull-right"><a href="../">&larr; Back to home</a></p>
      </div>
    </div>

    <div class="jumbotron">
      <h1>openssl wtf</h1>
      <div class="lead">
        <p>
          A minor WTF in openssl, where mixing encryption &amp; decryption functions
          does not result in an error. This can lead to subtle security bugs if the
          code is poorly written.
        </p>
        <p>
          A sane library should fail at the EVP_DecryptUpdate on line 112. Running
          this code (openssl 1.0.1) however results in:
        </p>
        <pre>
Encrypting:
-&gt; everything is fine, let's move on...

Decrypting, correctly:
plain text: hello world
-&gt; everything is fine, let's move on...

Decrypting a subset, with EVP_EncryptInit_ex
plain text: hello wor
-&gt; everything is fine, let's move on...

Decrypting a subset, with EVP_DecryptInit_ex
plain text: hello wor
EVP_DecryptFinal_ex failed!
</pre>
      </div>
    </div>

<p>openssl_wtf.c:</p>
<pre class="prettyprint linenums lang-c">
/**
 * openssl's EVP library does not prevent you from mixing
 * encryption &amp; decryption functions on a given ctx. This
 * can lead to subtle bugs if the code is poorly written.
 * Data will get decrypted but not authenticated!
 *
 * Compile and run with:
 * gcc -o openssl_wtf openssl_wtf.c
 *            -L/usr/lib/x86_64-linux-gnu/ -lssl -lcrypto
 * ./openssl_wtf
 */
#include &lt;stdio.h&gt;
#include &lt;strings.h&gt;
#include &lt;openssl/bio.h&gt;
#include &lt;openssl/evp.h&gt;

void assert(int exp, char *msg) {
  if (!exp) {
    printf("%s\n", msg);
    exit(-1);
  }
}

int main(int argc, char **argv) {
  unsigned char *key = "blah";

  unsigned char iv[] = {
    0x0d, 0x18, 0xe0, 0x6c, 0x7c, 0x72, 0x5a, 0xc9,
    0xe3, 0x62, 0xe1, 0xce
  };
  unsigned char tag[16] = { 0x00 };
  unsigned char pt1[] =
    {'h', 'e', 'l', 'l', 'o', ' ', 'w', 'o', 'r', 'l', 'd'};
  unsigned char ct[sizeof(pt1)];
  unsigned char pt2[sizeof(pt1)];

  EVP_CIPHER_CTX ctx;
  int ct_offset, pt2_offset, t, r;

  EVP_CIPHER_CTX_init(&ctx);


  /* Encrypt plain text */
  printf("Encrypting:\n");
  bzero(ct, sizeof(pt1));
  r = EVP_EncryptInit_ex(&ctx, EVP_aes_256_gcm(), NULL, key, iv);
  assert(r == 1, "EVP_EncryptInit_ex failed!");

  ct_offset = 0;

  r = EVP_EncryptUpdate(&ctx, ct + ct_offset, &t, pt1, sizeof(pt1));
  ct_offset += t;
  assert(r == 1, "EVP_EncryptUpdate failed!");

  r = EVP_EncryptFinal_ex(&ctx, ct + ct_offset, &t);
  ct_offset += t;
  assert(r == 1, "EVP_EncryptFinal_ex failed!");

  assert(ct_offset == sizeof(pt1), "unxpected ct len");

  /* Save tag */
  EVP_CIPHER_CTX_ctrl(&ctx, EVP_CTRL_GCM_GET_TAG, sizeof(tag), tag);

  EVP_CIPHER_CTX_cleanup(&ctx);

  printf("-&gt; everything is fine, let's move on...\n\n");


  /* Decrypt the cipher text */
  printf("Decrypting, correctly:\n");
  bzero(pt2, sizeof(pt1));
  EVP_CIPHER_CTX_init(&ctx);

  r = EVP_DecryptInit_ex(&ctx, EVP_aes_256_gcm(), NULL, key, iv);
  assert(r == 1, "EVP_DecryptInit_ex failed!");

  EVP_CIPHER_CTX_ctrl(&ctx, EVP_CTRL_GCM_SET_TAG, sizeof(tag), tag);

  pt2_offset = 0;

  r = EVP_DecryptUpdate(&ctx, pt2 + pt2_offset, &t, ct, sizeof(ct));
  pt2_offset += t;
  assert(r == 1, "EVP_DecryptUpdate failed!");

  r = EVP_DecryptFinal_ex(&ctx, pt2 + pt2_offset, &t);
  pt2_offset += t;
  assert(r == 1, "EVP_DecryptFinal_ex failed!");

  assert(pt2_offset == sizeof(pt1), "unexpected pt2 len");

  printf("plain text: %s\n", pt2);
  for (t=0; t&lt;sizeof(pt1); t++) {
    assert(pt1[t] == pt2[t], "pt2 != p1");
  }
  EVP_CIPHER_CTX_cleanup(&ctx);

  printf("-&gt; everything is fine, let's move on...\n\n");


  /* Decrypt a subset */
  printf("Decrypting a subset, with EVP_EncryptInit_ex\n");
  bzero(pt2, sizeof(pt1));
  EVP_CIPHER_CTX_init(&ctx);

  r = EVP_EncryptInit_ex(&ctx, EVP_aes_256_gcm(), NULL, key, iv);
  assert(r == 1, "EVP_DecryptInit_ex failed!");

  EVP_CIPHER_CTX_ctrl(&ctx, EVP_CTRL_GCM_SET_TAG, sizeof(tag), tag);

  pt2_offset = 0;

  r = EVP_DecryptUpdate(&ctx, pt2 + pt2_offset, &t, ct, sizeof(ct) - 2);
  pt2_offset += t;
  assert(r == 1, "EVP_DecryptUpdate failed!");

  r = EVP_DecryptFinal_ex(&ctx, pt2 + pt2_offset, &t);
  pt2_offset += t;
  printf("plain text: %s\n", pt2);

  assert(r == 1, "EVP_DecryptFinal_ex failed!");

  EVP_CIPHER_CTX_cleanup(&ctx);

  printf("-&gt; everything is fine, let's move on...\n\n");


  /* Decrypt a subset */
  printf("Decrypting a subset, with EVP_DecryptInit_ex\n");
  bzero(pt2, sizeof(pt1));
  EVP_CIPHER_CTX_init(&ctx);

  r = EVP_DecryptInit_ex(&ctx, EVP_aes_256_gcm(), NULL, key, iv);
  assert(r == 1, "EVP_DecryptInit_ex failed!");

  EVP_CIPHER_CTX_ctrl(&ctx, EVP_CTRL_GCM_SET_TAG, sizeof(tag), tag);

  pt2_offset = 0;

  r = EVP_DecryptUpdate(&ctx, pt2 + pt2_offset, &t, ct, sizeof(ct) - 2);
  pt2_offset += t;
  assert(r == 1, "EVP_DecryptUpdate failed!");

  r = EVP_DecryptFinal_ex(&ctx, pt2 + pt2_offset, &t);
  pt2_offset += t;
  printf("plain text: %s\n", pt2);

  assert(r == 1, "EVP_DecryptFinal_ex failed!");

  EVP_CIPHER_CTX_cleanup(&ctx);

  printf("-&gt; everything is fine, let's move on...\n\n");
}
</pre>

    <footer class="footer">
      <div style="float: left" class="fb-like" data-send="false" data-width="450" data-show-faces="false"></div>
      <p class="pull-right visible-desktop">
        <a href="https://github.com/alokmenghrajani/alokmenghrajani.github.com/issues/new">contact me</a>
        <span class="vbar"></span>
        <a href="#">back to top &uarr;</a>
      </p>
    </footer>
  </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2373559-12', 'quaxio.com');
  ga('send', 'pageview');
</script>

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=202717489767277";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  </body>
</html>

