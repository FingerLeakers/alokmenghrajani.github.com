<!DOCTYPE html>
<html lang="en">
<head>
  <title>Alok Menghrajani's stuff | qrquine</title>
  <meta property="fb:admins" content="536181839"/>
  <meta name="author" content="Alok Menghrajani"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../bootstrap-responsive.min.css" rel="stylesheet">
  <link href="../bootstrap-2.3.1.min.css" rel="stylesheet"/>
  <link href="../alok.css" rel="stylesheet"/>
  <script type="text/javascript" src="../jquery-1.7.1.min.js"></script>
</head>
<body>
  <div class="container-narrow">
    <div class="menu visible-desktop">
      <div class="profile">
        <p class="pull-right"><a href="../">&larr; Back to home</a></p>
      </div>
    </div>

    <div class="jumbotron">
      <h1>qrquine</h1>
      <div class="lead">
        <p>
          Have you ever tried to embed a QR code inside a QR code?
        </p>
        <p>
          Quines are little programs which produce copies of themselves. I figured it would be fun and challenging to try to make a QR code based quine.
          My QR code contains a piece of javascript which is able to re-generate the same QR code. The javascript is encoded as a data URI. It reads itself
          (location.href) and then encodes the same image, ad infinitum.
        </p>
        <p>
          I started with <a href="https://github.com/jeromeetienne/jquery-qrcode/blob/master/src/qrcode.js" class="external">Jerome Etienne's qrcode.js</a> library,
          and size optimized the code by a factor 10 (from ~28000 bytes to less than 2500).
        </p>
      </div>
    </div>

    <section>
      <img src="qrquine.png">
      <br><br><p>Note: my phone is unable to scan this code because of the poor camera resolution. You can however feed the image to an
        <a href="http://qr4.cloudapp.net/Free-Online-QR-Code-Reader.aspx" class="external">online QR code service</a>. If time permits, I'll try to shave a few hundred more
        bytes and drop into a smaller QR code version.
      </p>
    </section>

    <section>
      <div class="page-header"><h3>The javascript</h3></div>
      <p>Here is the data which is embedded in the above image.</p>

      <pre>data:text/html,&lt;body style=padding:9>&lt;canvas id=q>&lt;script>function fs(r,c,v){v&&cx.fillRect(c*3,r*3,3,3);id[3*C*c+r]=v}function fi(i,j){for(r=-1;r&lt;8;r++)if(i+r>-1&&C>i+r)for(c=-1;c&lt;8;c++)fs(i+r,j+c,0&lt;r&&(r&lt;7&&!(c%6))||((c+1)%8&&!(r%6)||1&lt;r&&(r&lt;5&&(1&lt;c&&c&lt;5))))}Z=[];Y=[];for(i=0;i&lt;8;i++)Z[i]=1&lt;&lt;i;for(i=8;i&lt;512;i++)for(j=4;j&lt;9;j++)if(j-7)Z[i]^=Z[i-j];for(i=0;i&lt;255;Y[Z[i]]=i++);function P(n,shift){la=n[L];for(o=0;o&lt;la&&n[o]==0;)o++;this.n=new Array(la-o+shift);for(ia=0;ia&lt;la-o;ia++)this.n[ia]=n[ia+o]}function N(T,e){n=[];for(ib=0;ib&lt;T.n[L];ib++)for(j=0;j&lt;e.n[L];j++)n[ib+j]^=Z[Y[T.n[ib]]+Y[e.n[j]]];return new P(n,0)}function M(T,e){if(T.n[L]-e.n[L]&lt;0)return T;n=[];for(i=0;i&lt;T.n[L];i++)n[i]=T.n[i];for(i=0;i&lt;e.n[L];i++)n[i]^=Z[Y[e.n[i]]+Y[T.n[0]]-Y[e.n[0]]];return M(new P(n,0),e)}function BP(n,l){for(ic=0;ic&lt;l;ic++)Bp(n>>>l-ic-1&1)}function Bp(bit){ie=Math.floor(this.l/8);if(bf[L]&lt;=ie)bf.push(0);if(bit)bf[ie]|=128>>>this.l%8;l++}bf=[];C=165;L="length";q.height=q.width=C*3;cx=q.getContext("2d");id=[];fi(0,0);fi(C-7,0);fi(l=i=0,C-7);po=[6,28,54,80,106,132,158];for(;i&lt;7;i++)for(j=0;j&lt;7;j++)if(!id[3*C*po[j]+po[i]])for(r=-2;r&lt;3;r++)for(c=-2;c&lt;3;c++)fs(po[i]+r,po[j]+c,r&&!(r%2)||(c&&!(c%2)||!r&&!c));a=[];for(i=8;i&lt;C-8;i++){a[i]|=1-i%2;fs(i,6,a[i]);fs(6,i,a[i])}for(i=0;i&lt;15;i++){m=30877>>i&1;if(i&lt;6)fs(i,8,m);else if(i&lt;8)fs(i+1,8,m);else fs(C-15+i,8,m);if(i&lt;8)fs(8,C-i-1,m);else if(i&lt;9)fs(8,15-i,m);else fs(8,15-i-1,m)}fs(C-8,8,1);for(i=0;i&lt;18;i++){m=152622>>i&1;a=Math.floor(i/3);b=i%3+C-11;fs(a,b,m);fs(b,a,m)}rB=[];for(j=0;j&lt;17;j++)rB.push({tc:152,dc:122});for(j=0;j&lt;4;j++)rB.push({tc:153,dc:123});d=location.href;BP(4,4);BP(2518,16);for(i=0;i&lt;2518;i++)BP(d.charCodeAt(i),8);tt=2566;if(l+3&lt;tt*8)BP(0,4);for(;l%8;)Bp(0);for(;;){if(l>=tt*8)break;BP(236,8);if(l>=tt*8)break;BP(17,8)}oa=eX=dX=0;dd=[];ed=[];for(r=0;r&lt;rB[L];r++){dC=rB[r].dc;eC=rB[r].tc-dC;dX=Math.max(dX,dC);eX=Math.max(eX,eC);dd[r]=[];for(i=0;i&lt;dC;i++)dd[r][i]=bf[i+oa];oa+=dC;p=new P([1],0);for(i=0;i&lt;eC;i++)p=N(p,new P([1,Z[i]],0));l=p.n[L]-1;q=new P(dd[r],l);m=M(q,p);ed[r]=[];for(i=0;i&lt;l;i++){j=i+m.n[L]-l;ed[r][i]=j>=0?m.n[j]:0}}D=[];for(Bi=j=i=0;i&lt;dX;i++)for(r=0;r&lt;rB[L];r++)if(i&lt;dd[r][L])D[j++]=dd[r][i];for(i=0;i&lt;eX;i++)for(r=0;r&lt;rB[L];r++)if(i&lt;ed[r][L])D[j++]=ed[r][i];iN=-1;bi=7;for(ro=co=C-1;co>0;co-=2)for(co==6&&co--;;){for(c=0;c&lt;2;c++)if(id[3*C*(co-c)+ro]==null){d=0;if(Bi&lt;D[L])d=D[Bi]>>>bi&1;if(!((ro+co-c)%3))d=!d;fs(ro,co-c,d);bi--;if(bi&lt;0){Bi++;bi=7}}ro+=iN;if(ro&lt;0||C&lt;=ro){ro-=iN;iN=-iN;break}}console.log("-- Alok")&lt;/script></pre>
    </section>

    <section>
      <h3>links</h3>
      <ul>
        <li><a href="http://en.wikipedia.org/wiki/Quine_(computing)">Read more about quines</a></li>
        <li><a href="https://github.com/jeromeetienne/jquery-qrcode/blob/master/src/qrcode.js">Open source qrcode library in JS</a></li>
        <li><a href="http://en.wikipedia.org/wiki/QR_code">Information about QR codes</a></li>
        <li><a href="http://www.qrcode.com/en/about/version.html">More information about QR codes</a></li>
      </ul>

      <small>
        The word "QR Code" is registered trademark of DENSO WAVE INCORPORATED (http://www.denso-wave.com/qrcode/)
      </small>
    </section>

    <footer class="footer">
      <div style="float: left" class="fb-like" data-send="false" data-width="450" data-show-faces="false"></div>
      <p class="pull-right visible-desktop">
        <a href="https://github.com/alokmenghrajani/alokmenghrajani.github.com/issues/new">contact me</a>
        <span class="vbar"></span>
        <a href="#">back to top &uarr;</a>
      </p>
    </footer>
  </div>

  <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
  <script type="text/jsx" src="wait_or_join.js"></script>
  <script type="text/jsx" src="cell.js"></script>
  <script type="text/jsx" src="tictactoe.js"></script>
  <script type="text/jsx" src="chat.js"></script>
  <script type="text/jsx" src="game.js"></script>
  <script type="text/jsx">
    /**
     * @jsx React.DOM
     */

    function StartGame() {
      this.started = false;

      // Start Firebase only once the page is visible. I was running into "ghost" users issues
      // without this.

      // Set the name of the hidden property and the change event for visibility
      this.hidden = "undefined";
      var visibilityChange;
      if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
        this.hidden = "hidden";
        visibilityChange = "visibilitychange";
      } else if (typeof document.mozHidden !== "undefined") {
        this.hidden = "mozHidden";
        visibilityChange = "mozvisibilitychange";
      } else if (typeof document.msHidden !== "undefined") {
        this.hidden = "msHidden";
        visibilityChange = "msvisibilitychange";
      } else if (typeof document.webkitHidden !== "undefined") {
        this.hidden = "webkitHidden";
        visibilityChange = "webkitvisibilitychange";
      }

      // Check if the browser supports addEventListener and Page Visibility API
      if (typeof document.addEventListener === "undefined" ||
          typeof this.hidden === "undefined") {
        this.go();
      } else {
        // Handle page visibility change
        document.addEventListener(visibilityChange, this.handleVisibilityChange.bind(this), false);
        // Call it once in case we started out visible.
        this.handleVisibilityChange();
      }
    }

    StartGame.prototype.handleVisibilityChange = function() {
      // if the page is shown, start the game
      if (!document[this.hidden]) {
        if (!this.started) {
          this.started = true;
          this.go();
        }
      }
    }

    StartGame.prototype.go = function() {
      console.log("StartGame: go");
      var firebase = new Firebase('https://reacttictactoe.firebaseIO-demo.com/');
      var path = firebase.child('users').push();
      path.onDisconnect().remove(
        function(err) {
          if (err) {
            console.log("onDisconnect failed: "+err);
            throw err;
          }
          var status = path.set(true);
          var id = path.name();

          // leak these for debugging purpose
          game = React.renderComponent(<Game id={id}/>, document.getElementById('game'));
          alok = new WaitOrJoin(
            id,
            firebase,
            game.onConnect.bind(game),
            game.onDisconnect.bind(game)
          );
        }.bind(this)
      );
    }
    new StartGame();
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2373559-12', 'quaxio.com');
  ga('send', 'pageview');
</script>

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=202717489767277";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  </body>
</html>
